<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Scanner Server - Móvil</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Prevenir zoom en inputs en iOS -->
    <meta name="format-detection" content="telephone=no">
</head>
<body>
    <div class="container">
        <!-- Header compacto -->
        <header class="header">
            <h1>🔫 Scanner Pro</h1>
            <div class="status" id="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Conectando...</span>
            </div>
        </header>

        <!-- Mensaje de seguridad HTTPS (solo si es necesario) -->
        <div class="security-warning" id="securityWarning" style="display: none;">
            <h3>⚠️ Acceso a Cámara Limitado</h3>
            <p>Los navegadores requieren HTTPS para acceder a la cámara.</p>
            <p><strong>Opciones:</strong></p>
            <ul>
                <li>📱 Usar Chrome en Android (permite HTTP en red local)</li>
                <li>🔒 Configurar HTTPS (avanzado)</li>
                <li>📁 Subir foto desde galería (botón abajo)</li>
            </ul>
        </div>

        <!-- Contenedor principal -->
        <main class="main-content">
            <!-- Video preview GRANDE con tap-to-focus -->
            <div class="camera-container" id="cameraContainer">
                <video id="video" autoplay playsinline muted style="display: none;"></video>
                <canvas id="canvas" style="display: none;"></canvas>
                
                <!-- Placeholder cuando no hay cámara -->
                <div class="camera-placeholder" id="cameraPlaceholder">
                    <div class="placeholder-content">
                        <div class="camera-icon">📷</div>
                        <p>Cámara no disponible</p>
                        <p class="placeholder-hint">Usa "Subir Foto" para escanear desde galería</p>
                    </div>
                </div>
                
                <!-- Overlay para el marco de escaneo optimizado -->
                <div class="scan-overlay" style="display: none;">
                    <div class="scan-frame">
                        <div class="corner top-left"></div>
                        <div class="corner top-right"></div>
                        <div class="corner bottom-left"></div>
                        <div class="corner bottom-right"></div>
                        
                        <!-- Punto de enfoque central -->
                        <div class="focus-center" id="focusCenter"></div>
                    </div>
                </div>
                
                <!-- Indicador de tap-to-focus -->
                <div class="focus-indicator" id="focusIndicator" style="display: none;">
                    <div class="focus-ring"></div>
                </div>
                
                <!-- Mensaje de instrucciones optimizado -->
                <div class="instructions" id="instructions">
                    👆 Presiona "Activar Cámara" para comenzar
                </div>
                
                <!-- Instrucciones de enfoque -->
                <div class="focus-hint" id="focusHint" style="display: none;">
                    📍 Toca la pantalla para enfocar • Apunta y presiona ESCANEAR
                </div>
            </div>

            <!-- CONTROLES PRINCIPALES - ESTILO PISTOLA LECTORA -->
            <div class="main-controls">
                <button id="startCamera" class="btn btn-primary large">
                    📹 Activar Cámara
                </button>
                
                <button id="scanBtn" class="btn btn-success large scanner-trigger" disabled>
                    🎯 ESCANEAR
                </button>
            </div>

            <!-- Resultado Simplificado -->
            <div class="results" id="results" style="display: none;">
                <h3>✅ Código Escaneado:</h3>
                <div class="result-display">
                    <div class="result-code" id="resultCode">-</div>
                </div>
                <button id="copyResult" class="btn btn-outline small">📋 Copiar</button>
            </div>

            <!-- CONTROLES ADICIONALES COMPACTOS -->
            <div class="secondary-controls">
                <button id="prepareFocus" class="btn btn-outline" style="display: none;">
                    🎯 Preparar Foco
                </button>
                
                <button id="flashBtn" class="btn btn-secondary" style="display: none;">
                    💡 Flash
                </button>
                
                <button id="autoFocusBtn" class="btn btn-outline" style="display: none;">
                    🔍 Auto-Enfoque
                </button>
                
                <button id="uploadBtn" class="btn btn-secondary small">
                    📁 Subir
                </button>
                
                <a href="/buscar" class="btn btn-outline small">
                    🔍 Buscar
                </a>
                
                <button id="configToggle" class="btn btn-outline small">
                    ⚙️ Config
                </button>
            </div>

            <input type="file" id="fileInput" accept="image/*" capture="environment" style="display: none;">

            <!-- Configuración (colapsable) -->
            <div class="config-panel" id="configPanel" style="display: none;">
                <h4>⚙️ Configuración</h4>
                <div class="config-grid">
                    <label class="config-item">
                        <input type="checkbox" id="autoType" checked>
                        <span>Auto-escribir códigos</span>
                    </label>
                    <label class="config-item">
                        <input type="checkbox" id="addEnter" checked>
                        <span>Añadir Enter al final</span>
                    </label>
                    <label class="config-item">
                        <input type="checkbox" id="playSound" checked>
                        <span>Sonido al escanear</span>
                    </label>
                    <label class="config-item">
                        <input type="checkbox" id="continuousFocus" checked>
                        <span>Enfoque continuo</span>
                    </label>
                    <label class="config-item">
                        <input type="checkbox" id="tapToFocus" checked>
                        <span>Tap para enfocar</span>
                    </label>
                    <label class="config-item">
                        <input type="checkbox" id="autoCapture" checked>
                        <span>Captura automática de imagen</span>
                    </label>
                    <label class="config-item">
                        <input type="checkbox" id="showDebug">
                        <span>Información de debug</span>
                    </label>
                </div>
            </div>

            <!-- Debug info (colapsable) -->
            <div class="debug-info" id="debugInfo" style="display: none;">
                <h4>🔧 Información de depuración:</h4>
                <div class="debug-grid">
                    <div><strong>HTTPS:</strong> <span id="httpsStatus">-</span></div>
                    <div><strong>getUserMedia:</strong> <span id="getUserMediaStatus">-</span></div>
                    <div><strong>Navegador:</strong> <span id="browserInfo">-</span></div>
                    <div><strong>Autofoque:</strong> <span id="autoFocusStatus">-</span></div>
                    <div><strong>Último enfoque:</strong> <span id="lastFocusTime">-</span></div>
                    <div><strong>Gestión de foco:</strong> <span id="focusManagement">-</span></div>
                    <div><strong>Base de datos:</strong> <span id="databaseStatus">-</span></div>
                    <div><strong>Imágenes guardadas:</strong> <span id="totalImages">-</span></div>
                </div>
            </div>
        </main>

        <!-- Footer compacto -->
        <footer class="footer">
            <div class="footer-stats">
                <span>📊 Escaneados: <strong id="scanCount">0</strong></span>
                <span>📸 Imágenes: <strong id="imageCount">0</strong></span>
                <span>🖥️ <span id="serverInfo">Cargando...</span></span>
            </div>
        </footer>
    </div>

    <!-- Loading overlay -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Procesando...</p>
    </div>

    <!-- Toast notifications -->
    <div class="toast" id="toast"></div>

    <script>
        // Variables globales
        let video, canvas, context;
        let stream = null;
        let scanCount = 0;
        let imageCount = 0;
        let isFlashOn = false;
        let cameraAvailable = false;
        let audioContext = null;
        let currentTrack = null;
        let focusTimeout = null;
        let lastFocusTime = null;
        
        // Configuración
        let config = {
            autoType: true,
            addEnter: true,
            showDebug: false,
            playSound: true,
            continuousFocus: true,
            tapToFocus: true,
            autoCapture: true
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initializeElements();
            initializeAudio();
            checkCapabilities();
            checkServerStatus();
            setupEventListeners();
            loadConfiguration();
            
            // Prevenir zoom en iOS al tocar inputs
            document.addEventListener('touchstart', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') {
                    e.target.style.fontSize = '16px';
                }
            });
            
            // Actualizar información de ventanas después de un momento
            setTimeout(updateWindowInfo, 1000);
            
            // Cargar estadísticas de base de datos
            setTimeout(loadDatabaseStats, 1500);
        });

        function initializeElements() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            context = canvas.getContext('2d');
        }

        function initializeAudio() {
            // Inicializar contexto de audio para el beep
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (error) {
                console.warn('Web Audio API no soportada:', error);
            }
        }

        function playBeepSound() {
            if (!config.playSound || !audioContext) return;
            
            try {
                // Crear beep de pistola lectora (dos beeps rápidos)
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // Primer beep más agudo (confirmación)
                oscillator1.connect(gainNode);
                oscillator1.frequency.setValueAtTime(1200, audioContext.currentTime);
                oscillator1.frequency.setValueAtTime(1000, audioContext.currentTime + 0.05);
                
                // Segundo beep (éxito)
                oscillator2.connect(gainNode);
                oscillator2.frequency.setValueAtTime(800, audioContext.currentTime + 0.1);
                oscillator2.frequency.setValueAtTime(600, audioContext.currentTime + 0.2);
                
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.12, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
                
                oscillator1.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.08);
                
                oscillator2.start(audioContext.currentTime + 0.1);
                oscillator2.stop(audioContext.currentTime + 0.25);
                
            } catch (error) {
                console.warn('Error reproduciendo sonido de éxito:', error);
            }
        }

        function playErrorSound() {
            if (!config.playSound || !audioContext) return;
            
            try {
                // Crear sonido de error tipo pistola (buzz)
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.3);
                
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
                
            } catch (error) {
                console.warn('Error reproduciendo sonido de error:', error);
            }
        }

        function clearResults() {
            // Limpiar/ocultar resultados anteriores
            document.getElementById('results').style.display = 'none';
            document.getElementById('resultCode').textContent = '-';
        }

        function checkCapabilities() {
            // Verificar HTTPS
            const isHTTPS = window.location.protocol === 'https:';
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            document.getElementById('httpsStatus').textContent = isHTTPS ? 'Sí' : 'No';
            
            // Verificar getUserMedia
            const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            document.getElementById('getUserMediaStatus').textContent = hasGetUserMedia ? 'Disponible' : 'No disponible';
            
            // Información del navegador simplificada para móviles
            const userAgent = navigator.userAgent;
            let browserInfo = 'Desconocido';
            if (userAgent.includes('Chrome')) browserInfo = 'Chrome';
            else if (userAgent.includes('Firefox')) browserInfo = 'Firefox';
            else if (userAgent.includes('Safari')) browserInfo = 'Safari';
            else if (userAgent.includes('Edge')) browserInfo = 'Edge';
            
            document.getElementById('browserInfo').textContent = browserInfo;
            
            // Mostrar advertencia si no es HTTPS y no es localhost
            if (!isHTTPS && !isLocalhost) {
                document.getElementById('securityWarning').style.display = 'block';
            }
            
            // Verificar si podemos usar la cámara
            if (hasGetUserMedia && (isHTTPS || isLocalhost)) {
                cameraAvailable = true;
            } else {
                // Mostrar placeholder
                document.getElementById('cameraPlaceholder').style.display = 'flex';
                document.getElementById('startCamera').disabled = true;
                document.getElementById('startCamera').innerHTML = '❌ Cámara no disponible';
            }
        }

        function setupEventListeners() {
            // Botones principales
            document.getElementById('prepareFocus').addEventListener('click', prepareFocus);
            document.getElementById('startCamera').addEventListener('click', startCamera);
            document.getElementById('uploadBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('scanBtn').addEventListener('click', scanBarcode);
            document.getElementById('flashBtn').addEventListener('click', toggleFlash);
            document.getElementById('autoFocusBtn').addEventListener('click', triggerAutoFocus);
            document.getElementById('copyResult').addEventListener('click', copyResult);
            
            // Configuración
            document.getElementById('configToggle').addEventListener('click', toggleConfig);
            document.getElementById('autoType').addEventListener('change', updateConfig);
            document.getElementById('addEnter').addEventListener('change', updateConfig);
            document.getElementById('playSound').addEventListener('change', updateConfig);
            document.getElementById('continuousFocus').addEventListener('change', updateConfig);
            document.getElementById('tapToFocus').addEventListener('change', updateConfig);
            document.getElementById('autoCapture').addEventListener('change', updateConfig);
            document.getElementById('showDebug').addEventListener('change', toggleDebug);
            
            // Eventos de video
            video.addEventListener('loadedmetadata', function() {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            });

            // TAP-TO-FOCUS en el contenedor de la cámara
            document.getElementById('cameraContainer').addEventListener('click', handleTapToFocus);

            // Habilitar audio context con interacción del usuario
            document.addEventListener('click', function() {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }, { once: true });

            // Prevenir zoom en iOS
            document.addEventListener('gesturestart', function (e) {
                e.preventDefault();
            });
        }

        async function startCamera() {
            if (!cameraAvailable) {
                showToast('❌ Cámara no disponible. Usa "Subir Foto"', 'error');
                playErrorSound();
                return;
            }

            // Limpiar resultados anteriores al activar cámara
            clearResults();

            try {
                // CONFIGURACIONES OPTIMIZADAS PARA ESCANEO DE CÓDIGOS
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920, min: 1280 },
                        height: { ideal: 1080, min: 720 },
                        // OPTIMIZACIONES DE AUTOFOQUE
                        focusMode: 'continuous',
                        focusDistance: { ideal: 0.3 }, // Distancia óptima para códigos (30cm)
                        exposureMode: 'continuous',
                        whiteBalanceMode: 'continuous',
                        // Configuraciones adicionales para códigos
                        frameRate: { ideal: 30, min: 15 },
                        aspectRatio: { ideal: 16/9 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Obtener track para controles avanzados
                currentTrack = stream.getVideoTracks()[0];
                
                // Aplicar configuraciones avanzadas si están disponibles
                await applyAdvancedCameraSettings();
                
                // Mostrar video
                video.style.display = 'block';
                document.getElementById('cameraPlaceholder').style.display = 'none';
                document.querySelector('.scan-overlay').style.display = 'flex';
                document.getElementById('focusHint').style.display = 'block';
                
                document.getElementById('startCamera').style.display = 'none';
                document.getElementById('scanBtn').disabled = false;
                document.getElementById('prepareFocus').style.display = 'inline-block';
                document.getElementById('autoFocusBtn').style.display = 'inline-block';
                document.getElementById('instructions').textContent = '🎯 Apunta al código y presiona ESCANEAR';
                
                // Mostrar botón de flash si está disponible
                const capabilities = currentTrack.getCapabilities();
                if (capabilities.torch) {
                    document.getElementById('flashBtn').style.display = 'inline-block';
                }
                
                // Verificar capacidades de autofoque
                updateAutoFocusStatus(capabilities);
                
                // Activar enfoque automático en el centro
                setTimeout(() => {
                    focusAtCenter();
                }, 1000);
                
                showToast('📹 Cámara optimizada activada', 'success');
                
            } catch (error) {
                console.error('Error accediendo a la cámara:', error);
                
                let errorMessage = 'Error accediendo a la cámara';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permiso de cámara denegado';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No se encontró cámara';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'Cámara no soportada';
                }
                
                playErrorSound();
                showToast(`❌ ${errorMessage}`, 'error');
                document.getElementById('instructions').textContent = '❌ ' + errorMessage;
            }
        }

        async function applyAdvancedCameraSettings() {
            if (!currentTrack) return;
            
            try {
                const capabilities = currentTrack.getCapabilities();
                const settings = {};
                
                // Configurar autofoque si está disponible
                if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                    settings.focusMode = 'continuous';
                }
                
                // Configurar distancia de enfoque para códigos de barras
                if (capabilities.focusDistance) {
                    settings.focusDistance = 0.3; // 30cm - ideal para códigos
                }
                
                // Configurar exposición automática
                if (capabilities.exposureMode && capabilities.exposureMode.includes('continuous')) {
                    settings.exposureMode = 'continuous';
                }
                
                // Aplicar configuraciones
                if (Object.keys(settings).length > 0) {
                    await currentTrack.applyConstraints({ advanced: [settings] });
                    console.log('✅ Configuraciones avanzadas aplicadas:', settings);
                }
                
            } catch (error) {
                console.warn('⚠️ No se pudieron aplicar configuraciones avanzadas:', error);
            }
        }

        function updateAutoFocusStatus(capabilities) {
            let status = 'Básico';
            
            if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                status = 'Continuo disponible';
            }
            
            if (capabilities.focusDistance) {
                status += ' + Control distancia';
            }
            
            document.getElementById('autoFocusStatus').textContent = status;
        }

        async function handleTapToFocus(event) {
            if (!config.tapToFocus || !currentTrack || !stream) return;
            
            // Evitar que se active en botones
            if (event.target.tagName === 'BUTTON') return;
            
            // Obtener coordenadas del toque
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Convertir a coordenadas relativas (0-1)
            const relativeX = x / rect.width;
            const relativeY = y / rect.height;
            
            // Mostrar indicador visual
            showFocusIndicator(x, y);
            
            // Aplicar enfoque en el punto tocado
            await focusAtPoint(relativeX, relativeY);
            
            // Actualizar tiempo de último enfoque
            lastFocusTime = new Date().toLocaleTimeString();
            document.getElementById('lastFocusTime').textContent = lastFocusTime;
        }

        function showFocusIndicator(x, y) {
            const indicator = document.getElementById('focusIndicator');
            
            // Posicionar indicador
            indicator.style.left = (x - 25) + 'px';
            indicator.style.top = (y - 25) + 'px';
            indicator.style.display = 'block';
            
            // Animar indicador
            indicator.classList.add('focusing');
            
            // Ocultar después de 1 segundo
            setTimeout(() => {
                indicator.style.display = 'none';
                indicator.classList.remove('focusing');
            }, 1000);
        }

        async function focusAtPoint(x, y) {
            if (!currentTrack) return;
            
            try {
                const capabilities = currentTrack.getCapabilities();
                
                // Si soporta control de punto de enfoque
                if (capabilities.pointsOfInterest) {
                    await currentTrack.applyConstraints({
                        advanced: [{
                            pointsOfInterest: [{ x: x, y: y }]
                        }]
                    });
                    console.log(`🎯 Enfoque aplicado en: ${x.toFixed(2)}, ${y.toFixed(2)}`);
                } else {
                    // Fallback: activar enfoque manual temporal
                    await triggerAutoFocus();
                }
                
            } catch (error) {
                console.warn('⚠️ Error aplicando enfoque en punto:', error);
                // Fallback a autofoque general
                await triggerAutoFocus();
            }
        }

        async function focusAtCenter() {
            // Enfocar automáticamente en el centro del marco de escaneo
            await focusAtPoint(0.5, 0.5);
            
            // Mostrar brevemente el indicador central
            const centerElement = document.getElementById('focusCenter');
            centerElement.classList.add('active');
            
            setTimeout(() => {
                centerElement.classList.remove('active');
            }, 800);
        }

        async function triggerAutoFocus() {
            if (!currentTrack) return;
            
            try {
                // Forzar reenfoque aplicando y removiendo constraint
                await currentTrack.applyConstraints({
                    advanced: [{
                        focusMode: 'single-shot'
                    }]
                });
                
                // Volver a modo continuo después de un momento
                setTimeout(async () => {
                    try {
                        await currentTrack.applyConstraints({
                            advanced: [{
                                focusMode: 'continuous'
                            }]
                        });
                    } catch (e) {
                        console.debug('Modo continuo no soportado');
                    }
                }, 500);
                
                showToast('🔍 Autofoque activado', 'info');
                
            } catch (error) {
                console.warn('⚠️ Error con autofoque manual:', error);
                showToast('⚠️ Autofoque no disponible', 'warning');
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Limpiar resultados anteriores al cargar nueva foto
            clearResults();

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Dibujar imagen en canvas
                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0);
                    
                    // Habilitar botón de escaneo
                    document.getElementById('scanBtn').disabled = false;
                    document.getElementById('instructions').textContent = '✅ Foto cargada - Presiona ESCANEAR';
                    
                    showToast('📁 Foto cargada correctamente', 'success');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function toggleFlash() {
            if (!stream) return;
            
            try {
                await currentTrack.applyConstraints({
                    advanced: [{torch: !isFlashOn}]
                });
                
                isFlashOn = !isFlashOn;
                document.getElementById('flashBtn').textContent = isFlashOn ? '🔆 Flash ON' : '💡 Flash OFF';
                
            } catch (error) {
                console.error('Error controlando flash:', error);
                showToast('❌ Flash no disponible', 'error');
            }
        }

        async function prepareFocus() {
            try {
                showToast('🎯 Preparando foco...', 'info');
                
                const response = await fetch('/prepare-focus', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const windowName = result.current_window ? result.current_window.name : 'Desconocida';
                    showToast(`✅ Foco preparado: ${windowName}`, 'success');
                    
                    // Actualizar info de debug
                    if (result.current_window) {
                        document.getElementById('currentWindow').textContent = windowName;
                        document.getElementById('rememberedWindow').textContent = windowName;
                    }
                } else {
                    showToast('⚠️ No se pudo preparar el foco', 'warning');
                }
                
                // Actualizar información de ventanas
                updateWindowInfo();
                
            } catch (error) {
                console.error('Error preparando foco:', error);
                showToast('❌ Error preparando foco', 'error');
            }
        }

        async function updateWindowInfo() {
            try {
                const response = await fetch('/window-info');
                const data = await response.json();
                
                if (data.current_window) {
                    document.getElementById('currentWindow').textContent = data.current_window.name || 'Desconocida';
                }
                
                document.getElementById('rememberedWindow').textContent = 
                    data.remembered_window ? 'Configurada' : 'No configurada';
                    
                document.getElementById('focusManagement').textContent = 
                    data.focus_management_available ? 'Disponible' : 'No disponible';
                
            } catch (error) {
                console.debug('Error obteniendo info de ventanas:', error);
            }
        }

        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/estadisticas');
                const stats = await response.json();
                
                document.getElementById('databaseStatus').textContent = 'Activa';
                document.getElementById('totalImages').textContent = stats.total_codes || 0;
                document.getElementById('imageCount').textContent = stats.total_codes || 0;
                
            } catch (error) {
                document.getElementById('databaseStatus').textContent = 'Error';
                document.getElementById('totalImages').textContent = 'N/A';
                console.debug('Error cargando estadísticas:', error);
            }
        }

        async function scanBarcode() {
            // LIMPIAR resultados anteriores al iniciar nuevo escaneo
            clearResults();
            
            // Activar enfoque antes del escaneo si está disponible
            if (config.continuousFocus && currentTrack) {
                await focusAtCenter();
                // Pequeña pausa para que el enfoque se estabilice
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            let imageData;
            
            if (video.style.display !== 'none' && video.videoWidth) {
                // Escanear desde video
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                imageData = canvas.toDataURL('image/jpeg', 0.9); // Mayor calidad para códigos
            } else if (canvas.width > 0) {
                // Escanear desde imagen cargada
                imageData = canvas.toDataURL('image/jpeg', 0.9);
            } else {
                showToast('❌ No hay imagen para escanear', 'error');
                playErrorSound();
                return;
            }

            // Preparar foco automáticamente antes del escaneo
            if (config.autoType) {
                try {
                    await fetch('/prepare-focus', { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                } catch (error) {
                    console.debug('No se pudo preparar foco automáticamente:', error);
                }
            }

            document.getElementById('loading').style.display = 'flex';
            
            try {
                const response = await fetch('/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    const barcode = result.barcodes[0];
                    
                    // Reproducir sonido de éxito tipo pistola lectora
                    playBeepSound();
                    
                    // Mostrar SOLO el código actual
                    showResults(barcode.data);
                    scanCount++;
                    document.getElementById('scanCount').textContent = scanCount;
                    showToast(`✅ ${result.message}`, 'success');
                    
                    // NUEVA FUNCIONALIDAD: Conteo regresivo y captura automática
                    if (config.autoCapture && video.style.display !== 'none' && video.videoWidth) {
                        startCountdownAndCapture(barcode.data);
                    }
                    
                    // Actualizar información de ventanas después del escaneo
                    setTimeout(updateWindowInfo, 1000);
                } else {
                    // LIMPIAR pantalla cuando no se encuentran códigos
                    clearResults();
                    
                    // Reproducir sonido de error
                    playErrorSound();
                    showToast(`⚠️ ${result.message}`, 'warning');
                    
                    // Reactivar autofoque si falló
                    if (currentTrack && config.continuousFocus) {
                        setTimeout(triggerAutoFocus, 500);
                    }
                }
                
            } catch (error) {
                console.error('Error escaneando:', error);
                
                // LIMPIAR pantalla en caso de error de conexión
                clearResults();
                
                // Reproducir sonido de error
                playErrorSound();
                showToast('❌ Error al escanear', 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function showResults(codeValue) {
            // Mostrar SOLO el código escaneado
            document.getElementById('resultCode').textContent = codeValue;
            document.getElementById('results').style.display = 'block';
        }

        function startCountdownAndCapture(codigo) {
            // Crear overlay de conteo regresivo
            const countdownOverlay = createCountdownOverlay();
            document.body.appendChild(countdownOverlay);
            
            let countdown = 2;
            const countdownElement = countdownOverlay.querySelector('.countdown-number');
            const messageElement = countdownOverlay.querySelector('.countdown-message');
            
            // Actualizar conteo inicial
            countdownElement.textContent = countdown;
            messageElement.textContent = 'Preparando captura automática...';
            
            const countdownInterval = setInterval(() => {
                countdown--;
                
                if (countdown > 0) {
                    countdownElement.textContent = countdown;
                    messageElement.textContent = `Capturando imagen en ${countdown}...`;
                    
                    // Efecto de pulso en la cámara
                    document.getElementById('cameraContainer').style.borderColor = '#10b981';
                    setTimeout(() => {
                        document.getElementById('cameraContainer').style.borderColor = '#059669';
                    }, 500);
                    
                } else {
                    clearInterval(countdownInterval);
                    
                    // Cambiar mensaje
                    countdownElement.textContent = '📸';
                    messageElement.textContent = 'Capturando imagen...';
                    
                    // Capturar imagen después de una breve pausa
                    setTimeout(() => {
                        captureAndSaveImage(codigo);
                        
                        // Remover overlay
                        setTimeout(() => {
                            if (countdownOverlay.parentNode) {
                                countdownOverlay.parentNode.removeChild(countdownOverlay);
                            }
                        }, 1000);
                        
                    }, 300);
                }
            }, 1000);
        }

        function createCountdownOverlay() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                color: white;
                text-align: center;
            `;
            
            overlay.innerHTML = `
                <div class="countdown-number" style="
                    font-size: 8rem;
                    font-weight: bold;
                    color: #10b981;
                    text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
                    animation: pulse 1s infinite;
                    margin-bottom: 1rem;
                ">2</div>
                
                <div class="countdown-message" style="
                    font-size: 1.5rem;
                    font-weight: 500;
                    margin-bottom: 2rem;
                ">Preparando captura automática...</div>
                
                <div style="
                    width: 60px;
                    height: 60px;
                    border: 4px solid rgba(16, 185, 129, 0.3);
                    border-top: 4px solid #10b981;
                    border-radius: 50%;
                    animation: spin 2s linear infinite;
                "></div>
                
                <div style="
                    margin-top: 1rem;
                    font-size: 1rem;
                    opacity: 0.8;
                ">📸 Sistema de imágenes activo</div>
            `;
            
            return overlay;
        }

        async function captureAndSaveImage(codigo) {
            try {
                // Crear flash visual para indicar captura
                createCaptureFlash();
                
                // Asegurar que el canvas tenga el tamaño correcto
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Capturar frame actual del video en resolución media
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convertir a base64 con calidad optimizada para resolución media
                const imageData = canvas.toDataURL('image/jpeg', 0.7);
                
                // Enviar al servidor
                const response = await fetch('/guardar-imagen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        imagen: imageData,
                        dispositivo: `Scanner Web - ${navigator.userAgent.includes('Mobile') ? 'Móvil' : 'Escritorio'}`
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('📸 Imagen guardada automáticamente', 'success');
                    console.log(`✅ Imagen guardada para código: ${codigo}`);
                    
                    // Actualizar contador de imágenes
                    imageCount++;
                    document.getElementById('imageCount').textContent = imageCount;
                    
                    // Actualizar estadísticas
                    setTimeout(loadDatabaseStats, 1000);
                } else {
                    showToast('⚠️ Error guardando imagen', 'warning');
                    console.error('Error guardando imagen:', result.error);
                }

            } catch (error) {
                console.error('Error en captura automática:', error);
                showToast('❌ Error en captura automática', 'error');
            }
        }

        function createCaptureFlash() {
            // Crear efecto de flash blanco para simular flash de cámara
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                z-index: 999;
                opacity: 0;
                pointer-events: none;
                animation: camera-flash 0.3s ease-out;
            `;
            
            // Agregar animación CSS si no existe
            if (!document.querySelector('#flash-animation-style')) {
                const style = document.createElement('style');
                style.id = 'flash-animation-style';
                style.textContent = `
                    @keyframes camera-flash {
                        0% { opacity: 0; }
                        50% { opacity: 0.8; }
                        100% { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(flash);
            
            // Remover flash después de la animación
            setTimeout(() => {
                if (flash.parentNode) {
                    flash.parentNode.removeChild(flash);
                }
            }, 300);
            
            // Efecto de sonido de cámara
            playBeepSound(); // Reutilizar el sonido de éxito
        }

        async function copyResult() {
            try {
                const resultCode = document.getElementById('resultCode').textContent;
                await navigator.clipboard.writeText(resultCode);
                showToast('📋 Código copiado al portapapeles', 'success');
            } catch (error) {
                showToast('❌ Error copiando al portapapeles', 'error');
            }
        }

        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
        }

        function toggleDebug() {
            const showDebug = document.getElementById('showDebug').checked;
            document.getElementById('debugInfo').style.display = showDebug ? 'block' : 'none';
        }

        function updateConfig() {
            config.autoType = document.getElementById('autoType').checked;
            config.addEnter = document.getElementById('addEnter').checked;
            config.playSound = document.getElementById('playSound').checked;
            config.continuousFocus = document.getElementById('continuousFocus').checked;
            config.tapToFocus = document.getElementById('tapToFocus').checked;
            config.autoCapture = document.getElementById('autoCapture').checked;
            
            fetch('/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    auto_type: config.autoType,
                    add_enter: config.addEnter
                })
            });
        }

        async function loadConfiguration() {
            try {
                const response = await fetch('/config');
                const serverConfig = await response.json();
                
                document.getElementById('autoType').checked = serverConfig.auto_type;
                document.getElementById('addEnter').checked = serverConfig.add_enter;
                
            } catch (error) {
                console.error('Error cargando configuración:', error);
            }
        }

        async function checkServerStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                updateStatus('online', 'Conectado');
                document.getElementById('serverInfo').textContent = `${window.location.host}`;
                
                // Actualizar información de gestión de foco si está disponible
                if (data.keyboard_status && data.keyboard_status.focus_management) {
                    document.getElementById('focusManagement').textContent = 'Disponible';
                    updateWindowInfo();
                } else {
                    document.getElementById('focusManagement').textContent = 'No disponible';
                }
                
                // Actualizar estadísticas de base de datos
                if (data.database_stats) {
                    document.getElementById('databaseStatus').textContent = 'Activa';
                    document.getElementById('totalImages').textContent = data.database_stats.total_codes || 0;
                    document.getElementById('imageCount').textContent = data.database_stats.total_codes || 0;
                }
                
            } catch (error) {
                updateStatus('offline', 'Desconectado');
                console.error('Error conectando al servidor:', error);
            }
        }

        function updateStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            dot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Auto-reconexión y actualización de estadísticas
        setInterval(checkServerStatus, 30000);
        setInterval(loadDatabaseStats, 60000); // Actualizar estadísticas cada minuto
    </script>
</body>
</html>