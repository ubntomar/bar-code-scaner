<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Scanner Server - Escaneo de C√≥digos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header compacto -->
        <header class="header">
            <h1>üì± Scanner Server</h1>
            <div class="status" id="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Conectando...</span>
            </div>
        </header>

        <!-- Mensaje de seguridad HTTPS -->
        <div class="security-warning" id="securityWarning" style="display: none;">
            <h3>‚ö†Ô∏è Acceso a C√°mara Limitado</h3>
            <p>Los navegadores requieren HTTPS para acceder a la c√°mara.</p>
            <p><strong>Opciones:</strong></p>
            <ul>
                <li>üì± Usar Chrome en Android (permite HTTP en red local)</li>
                <li>üîí Configurar HTTPS (avanzado)</li>
                <li>üìÅ Subir foto desde galer√≠a (bot√≥n abajo)</li>
            </ul>
        </div>

        <!-- Contenedor principal -->
        <main class="main-content">
            <!-- Video preview COMPACTO -->
            <div class="camera-container compact">
                <video id="video" autoplay playsinline muted style="display: none;"></video>
                <canvas id="canvas" style="display: none;"></canvas>
                
                <!-- Placeholder cuando no hay c√°mara -->
                <div class="camera-placeholder" id="cameraPlaceholder">
                    <div class="placeholder-content">
                        <div class="camera-icon">üì∑</div>
                        <p>C√°mara no disponible</p>
                        <p class="placeholder-hint">Usa "Subir Foto" para escanear desde galer√≠a</p>
                    </div>
                </div>
                
                <!-- Overlay para el marco de escaneo -->
                <div class="scan-overlay" style="display: none;">
                    <div class="scan-frame">
                        <div class="corner top-left"></div>
                        <div class="corner top-right"></div>
                        <div class="corner bottom-left"></div>
                        <div class="corner bottom-right"></div>
                    </div>
                </div>
                
                <!-- Mensaje de instrucciones -->
                <div class="instructions" id="instructions">
                    üëÜ Presiona "Activar C√°mara" para comenzar
                </div>
            </div>

            <!-- CONTROLES PRINCIPALES (m√°s prominentes) -->
            <div class="main-controls">
                <button id="startCamera" class="btn btn-primary large">
                    üìπ Activar C√°mara
                </button>
                
                <button id="scanBtn" class="btn btn-success large" disabled>
                    üîç ESCANEAR
                </button>
                
                <button id="prepareFocus" class="btn btn-outline" style="display: none;">
                    üéØ Preparar Foco
                </button>
                
                <button id="flashBtn" class="btn btn-secondary" style="display: none;">
                    üí° Flash
                </button>
            </div>

            <!-- Resultado Simplificado -->
            <div class="results" id="results" style="display: none;">
                <h3>‚úÖ C√≥digo Escaneado:</h3>
                <div class="result-display">
                    <div class="result-code" id="resultCode">-</div>
                </div>
                <button id="copyResult" class="btn btn-outline small">üìã Copiar</button>
            </div>

            <!-- CONTROLES SECUNDARIOS (menos prominentes) -->
            <div class="secondary-controls">
                <button id="uploadBtn" class="btn btn-secondary">
                    üìÅ Subir Foto
                </button>
                
                <input type="file" id="fileInput" accept="image/*" capture="environment" style="display: none;">
                
                <button id="configToggle" class="btn btn-outline">
                    ‚öôÔ∏è Configuraci√≥n
                </button>
            </div>

            <!-- Configuraci√≥n (colapsable) -->
            <div class="config-panel" id="configPanel" style="display: none;">
                <h4>‚öôÔ∏è Configuraci√≥n</h4>
                <div class="config-grid">
                    <label class="config-item">
                        <input type="checkbox" id="autoType" checked>
                        <span>Auto-escribir c√≥digos</span>
                    </label>
                    <label class="config-item">
                        <input type="checkbox" id="addEnter" checked>
                        <span>A√±adir Enter al final</span>
                    </label>
                    <label class="config-item">
                        <input type="checkbox" id="playSound" checked>
                        <span>Sonido al escanear</span>
                    </label>
                    <label class="config-item">
                        <input type="checkbox" id="showDebug">
                        <span>Informaci√≥n de debug</span>
                    </label>
                </div>
            </div>

            <!-- Debug info (colapsable) -->
            <div class="debug-info" id="debugInfo" style="display: none;">
                <h4>üîß Informaci√≥n de depuraci√≥n:</h4>
                <div class="debug-grid">
                    <div><strong>HTTPS:</strong> <span id="httpsStatus">-</span></div>
                    <div><strong>getUserMedia:</strong> <span id="getUserMediaStatus">-</span></div>
                    <div><strong>Navegador:</strong> <span id="browserInfo">-</span></div>
                    <div><strong>Gesti√≥n de foco:</strong> <span id="focusManagement">-</span></div>
                    <div><strong>Ventana actual:</strong> <span id="currentWindow">-</span></div>
                    <div><strong>Ventana recordada:</strong> <span id="rememberedWindow">-</span></div>
                </div>
            </div>
        </main>

        <!-- Footer compacto -->
        <footer class="footer">
            <div class="footer-stats">
                <span>üìä Escaneados: <strong id="scanCount">0</strong></span>
                <span>üñ•Ô∏è <span id="serverInfo">Cargando...</span></span>
            </div>
        </footer>
    </div>

    <!-- Loading overlay -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Procesando...</p>
    </div>

    <!-- Toast notifications -->
    <div class="toast" id="toast"></div>

    <script>
        // Variables globales
        let video, canvas, context;
        let stream = null;
        let scanCount = 0;
        let isFlashOn = false;
        let cameraAvailable = false;
        let audioContext = null;
        
        // Configuraci√≥n
        let config = {
            autoType: true,
            addEnter: true,
            showDebug: false,
            playSound: true
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initializeElements();
            initializeAudio();
            checkCapabilities();
            checkServerStatus();
            setupEventListeners();
            loadConfiguration();
            
            // Actualizar informaci√≥n de ventanas despu√©s de un momento
            setTimeout(updateWindowInfo, 1000);
        });

        function initializeElements() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            context = canvas.getContext('2d');
        }

        function initializeAudio() {
            // Inicializar contexto de audio para el beep
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (error) {
                console.warn('Web Audio API no soportada:', error);
            }
        }

        function playBeepSound() {
            if (!config.playSound || !audioContext) return;
            
            try {
                // Crear beep exitoso (dos tonos ascendentes)
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // Configurar primer tono (m√°s alto)
                oscillator1.connect(gainNode);
                oscillator1.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator1.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                
                // Configurar segundo tono (m√°s bajo)
                oscillator2.connect(gainNode);
                oscillator2.frequency.setValueAtTime(600, audioContext.currentTime + 0.15);
                oscillator2.frequency.setValueAtTime(800, audioContext.currentTime + 0.25);
                
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator1.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.15);
                
                oscillator2.start(audioContext.currentTime + 0.15);
                oscillator2.stop(audioContext.currentTime + 0.3);
                
            } catch (error) {
                console.warn('Error reproduciendo sonido de √©xito:', error);
            }
        }

        function playErrorSound() {
            if (!config.playSound || !audioContext) return;
            
            try {
                // Crear sonido de error (dos tonos descendentes)
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // Configurar primer tono (descendente)
                oscillator1.connect(gainNode);
                oscillator1.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator1.frequency.setValueAtTime(400, audioContext.currentTime + 0.15);
                
                // Configurar segundo tono (m√°s descendente)
                oscillator2.connect(gainNode);
                oscillator2.frequency.setValueAtTime(400, audioContext.currentTime + 0.2);
                oscillator2.frequency.setValueAtTime(200, audioContext.currentTime + 0.4);
                
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator1.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.2);
                
                oscillator2.start(audioContext.currentTime + 0.2);
                oscillator2.stop(audioContext.currentTime + 0.5);
                
            } catch (error) {
                console.warn('Error reproduciendo sonido de error:', error);
            }
        }

        function clearResults() {
            // Limpiar/ocultar resultados anteriores
            document.getElementById('results').style.display = 'none';
            document.getElementById('resultCode').textContent = '-';
        }

        function checkCapabilities() {
            // Verificar HTTPS
            const isHTTPS = window.location.protocol === 'https:';
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            document.getElementById('httpsStatus').textContent = isHTTPS ? 'S√≠' : 'No';
            
            // Verificar getUserMedia
            const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            document.getElementById('getUserMediaStatus').textContent = hasGetUserMedia ? 'Disponible' : 'No disponible';
            
            // Informaci√≥n del navegador
            document.getElementById('browserInfo').textContent = navigator.userAgent.split(' ').slice(-2).join(' ');
            
            // Mostrar advertencia si no es HTTPS y no es localhost
            if (!isHTTPS && !isLocalhost) {
                document.getElementById('securityWarning').style.display = 'block';
            }
            
            // Verificar si podemos usar la c√°mara
            if (hasGetUserMedia && (isHTTPS || isLocalhost)) {
                cameraAvailable = true;
            } else {
                // Mostrar placeholder
                document.getElementById('cameraPlaceholder').style.display = 'flex';
                document.getElementById('startCamera').disabled = true;
                document.getElementById('startCamera').innerHTML = '‚ùå C√°mara no disponible';
            }
        }

        function setupEventListeners() {
            // Botones principales
            document.getElementById('prepareFocus').addEventListener('click', prepareFocus);
            document.getElementById('startCamera').addEventListener('click', startCamera);
            document.getElementById('uploadBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('scanBtn').addEventListener('click', scanBarcode);
            document.getElementById('flashBtn').addEventListener('click', toggleFlash);
            document.getElementById('copyResult').addEventListener('click', copyResult);
            
            // Configuraci√≥n
            document.getElementById('configToggle').addEventListener('click', toggleConfig);
            document.getElementById('autoType').addEventListener('change', updateConfig);
            document.getElementById('addEnter').addEventListener('change', updateConfig);
            document.getElementById('playSound').addEventListener('change', updateConfig);
            document.getElementById('showDebug').addEventListener('change', toggleDebug);
            
            // Eventos de video
            video.addEventListener('loadedmetadata', function() {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            });

            // Habilitar audio context con interacci√≥n del usuario
            document.addEventListener('click', function() {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }, { once: true });
        }

        async function startCamera() {
            if (!cameraAvailable) {
                showToast('‚ùå C√°mara no disponible. Usa "Subir Foto"', 'error');
                playErrorSound(); // Sonido de error
                return;
            }

            // Limpiar resultados anteriores al activar c√°mara
            clearResults();

            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Mostrar video
                video.style.display = 'block';
                document.getElementById('cameraPlaceholder').style.display = 'none';
                document.querySelector('.scan-overlay').style.display = 'flex';
                
                document.getElementById('startCamera').style.display = 'none';
                document.getElementById('scanBtn').disabled = false;
                document.getElementById('prepareFocus').style.display = 'inline-block';
                document.getElementById('instructions').textContent = 'üéØ Apunta al c√≥digo y presiona ESCANEAR';
                
                // Mostrar bot√≥n de flash si est√° disponible
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                if (capabilities.torch) {
                    document.getElementById('flashBtn').style.display = 'inline-block';
                }
                
                showToast('üìπ C√°mara activada', 'success');
                
            } catch (error) {
                console.error('Error accediendo a la c√°mara:', error);
                
                let errorMessage = 'Error accediendo a la c√°mara';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permiso de c√°mara denegado';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No se encontr√≥ c√°mara';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'C√°mara no soportada';
                }
                
                playErrorSound(); // Sonido de error
                showToast(`‚ùå ${errorMessage}`, 'error');
                document.getElementById('instructions').textContent = '‚ùå ' + errorMessage;
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Limpiar resultados anteriores al cargar nueva foto
            clearResults();

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Dibujar imagen en canvas
                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0);
                    
                    // Habilitar bot√≥n de escaneo
                    document.getElementById('scanBtn').disabled = false;
                    document.getElementById('instructions').textContent = '‚úÖ Foto cargada - Presiona ESCANEAR';
                    
                    showToast('üìÅ Foto cargada correctamente', 'success');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function toggleFlash() {
            if (!stream) return;
            
            try {
                const track = stream.getVideoTracks()[0];
                await track.applyConstraints({
                    advanced: [{torch: !isFlashOn}]
                });
                
                isFlashOn = !isFlashOn;
                document.getElementById('flashBtn').textContent = isFlashOn ? 'üîÜ Flash ON' : 'üí° Flash OFF';
                
            } catch (error) {
                console.error('Error controlando flash:', error);
                showToast('‚ùå Flash no disponible', 'error');
            }
        }

        async function prepareFocus() {
            try {
                showToast('üéØ Preparando foco...', 'info');
                
                const response = await fetch('/prepare-focus', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const windowName = result.current_window ? result.current_window.name : 'Desconocida';
                    showToast(`‚úÖ Foco preparado: ${windowName}`, 'success');
                    
                    // Actualizar info de debug
                    if (result.current_window) {
                        document.getElementById('currentWindow').textContent = windowName;
                        document.getElementById('rememberedWindow').textContent = windowName;
                    }
                } else {
                    showToast('‚ö†Ô∏è No se pudo preparar el foco', 'warning');
                }
                
                // Actualizar informaci√≥n de ventanas
                updateWindowInfo();
                
            } catch (error) {
                console.error('Error preparando foco:', error);
                showToast('‚ùå Error preparando foco', 'error');
            }
        }

        async function updateWindowInfo() {
            try {
                const response = await fetch('/window-info');
                const data = await response.json();
                
                if (data.current_window) {
                    document.getElementById('currentWindow').textContent = data.current_window.name || 'Desconocida';
                }
                
                document.getElementById('rememberedWindow').textContent = 
                    data.remembered_window ? 'Configurada' : 'No configurada';
                    
                document.getElementById('focusManagement').textContent = 
                    data.focus_management_available ? 'Disponible' : 'No disponible';
                
            } catch (error) {
                console.debug('Error obteniendo info de ventanas:', error);
            }
        }

        async function scanBarcode() {
            // LIMPIAR resultados anteriores al iniciar nuevo escaneo
            clearResults();
            
            let imageData;
            
            if (video.style.display !== 'none' && video.videoWidth) {
                // Escanear desde video
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                imageData = canvas.toDataURL('image/jpeg', 0.8);
            } else if (canvas.width > 0) {
                // Escanear desde imagen cargada
                imageData = canvas.toDataURL('image/jpeg', 0.8);
            } else {
                showToast('‚ùå No hay imagen para escanear', 'error');
                playErrorSound(); // Sonido de error
                return;
            }

            // Preparar foco autom√°ticamente antes del escaneo
            if (config.autoType) {
                try {
                    await fetch('/prepare-focus', { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                } catch (error) {
                    console.debug('No se pudo preparar foco autom√°ticamente:', error);
                }
            }

            document.getElementById('loading').style.display = 'flex';
            
            try {
                const response = await fetch('/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    const barcode = result.barcodes[0];
                    
                    // Reproducir sonido de √©xito
                    playBeepSound();
                    
                    // Mostrar SOLO el c√≥digo actual (sin registros antiguos)
                    showResults(barcode.data);
                    scanCount++;
                    document.getElementById('scanCount').textContent = scanCount;
                    showToast(`‚úÖ ${result.message}`, 'success');
                    
                    // Actualizar informaci√≥n de ventanas despu√©s del escaneo
                    setTimeout(updateWindowInfo, 1000);
                } else {
                    // LIMPIAR pantalla cuando no se encuentran c√≥digos
                    clearResults();
                    
                    // Reproducir sonido de error en caso de fallo
                    playErrorSound();
                    showToast(`‚ö†Ô∏è ${result.message}`, 'warning');
                }
                
            } catch (error) {
                console.error('Error escaneando:', error);
                
                // LIMPIAR pantalla en caso de error de conexi√≥n
                clearResults();
                
                // Reproducir sonido de error
                playErrorSound();
                showToast('‚ùå Error al escanear', 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function showResults(codeValue) {
            // Mostrar SOLO el c√≥digo escaneado
            document.getElementById('resultCode').textContent = codeValue;
            document.getElementById('results').style.display = 'block';
        }

        async function copyResult() {
            try {
                const resultCode = document.getElementById('resultCode').textContent;
                await navigator.clipboard.writeText(resultCode);
                showToast('üìã C√≥digo copiado al portapapeles', 'success');
            } catch (error) {
                showToast('‚ùå Error copiando al portapapeles', 'error');
            }
        }

        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
        }

        function toggleDebug() {
            const showDebug = document.getElementById('showDebug').checked;
            document.getElementById('debugInfo').style.display = showDebug ? 'block' : 'none';
        }

        function updateConfig() {
            config.autoType = document.getElementById('autoType').checked;
            config.addEnter = document.getElementById('addEnter').checked;
            config.playSound = document.getElementById('playSound').checked;
            
            fetch('/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    auto_type: config.autoType,
                    add_enter: config.addEnter
                })
            });
        }

        async function loadConfiguration() {
            try {
                const response = await fetch('/config');
                const serverConfig = await response.json();
                
                document.getElementById('autoType').checked = serverConfig.auto_type;
                document.getElementById('addEnter').checked = serverConfig.add_enter;
                
            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
            }
        }

        async function checkServerStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                updateStatus('online', 'Conectado');
                document.getElementById('serverInfo').textContent = `${window.location.host}`;
                
                // Actualizar informaci√≥n de gesti√≥n de foco si est√° disponible
                if (data.keyboard_status && data.keyboard_status.focus_management) {
                    document.getElementById('focusManagement').textContent = 'Disponible';
                    // Actualizar informaci√≥n de ventanas
                    updateWindowInfo();
                } else {
                    document.getElementById('focusManagement').textContent = 'No disponible';
                }
                
            } catch (error) {
                updateStatus('offline', 'Desconectado');
                console.error('Error conectando al servidor:', error);
            }
        }

        function updateStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            dot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Auto-reconexi√≥n
        setInterval(checkServerStatus, 30000);
    </script>
</body>
</html>